# Copyright 2024 Canonical, Ltd.
# See LICENSE file for licensing details

name: csi-node-driver-registrar
summary: csi-node-driver-registrar rock
description: |
    A rock containing csi-node-driver-registrar.
license: Apache-2.0
version: 2.10.0

base: bare
build-base: ubuntu@22.04
run-user: _daemon_

platforms:
  amd64:
  arm64:

environment:
  APP_VERSION: 2.10.0

# Services to be loaded by the Pebble entrypoint.
services:
  csi-node-driver-registrar:
    summary: "csi-node-driver-registrar service"
    override: replace
    startup: enabled
    command: "/csi-node-driver-registrar"
    on-success: shutdown
    on-failure: shutdown

parts:
  build-csi-node-driver-registrar:
    plugin: go
    source: https://github.com/kubernetes-csi/node-driver-registrar.git
    source-type: git
    source-tag: v${CRAFT_PROJECT_VERSION}
    source-depth: 1
    build-snaps:
      - go/1.21/stable
    build-environment:
      - GOOS: linux
      - GOARCH: $CRAFT_ARCH_BUILD_FOR
    go-generate:
      - ./cmd/csi-node-driver-registrar
    organize:
      bin/csi-node-driver-registrar: ./
